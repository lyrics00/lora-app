{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load ratings_tags %}
{% block hero_content %}
<style>
  /* Overall card styling remains unchanged */
  .listing-detail-card {
    width: 100%;
    overflow: hidden;
    background-color: #000;
    color: #fff;
  }
  .listing-info {
    padding: 20px;
  }
  /* Main image container for the gallery */
  .main-image-container {
    flex-grow: 1;
    overflow: hidden;
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
    position: relative;
    margin-left: auto;
    width: 100%;
    height: 100%;
    display: flex;           
    font-size: 0;      /* Remove inline whitespace */
    line-height: 0;    /* Remove inline gaps */
  }

  /* Gallery image styling */
  .main-image-container img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    margin: 0;
    padding: 0;
    border-radius: 0;
  }
  
  /* Thumbnails styling remains as before */
  .thumbnail-container {
    width: 150px;
    overflow-y: auto;
    padding: 10px;
  }
  .thumbnail-container img {
    object-fit: cover;
    width: 100%;
    height: 80px;
    cursor: pointer;
    margin-bottom: 8px;
  }
  /* Gallery arrow buttons styling */
  .gallery-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    background-color: rgba(0, 0, 0, 0.5);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0.7;
    transition: opacity 0.3s;
  }
  .gallery-btn:hover {
    opacity: 1;
    background-color: rgba(0, 0, 0, 0.7);
  }
  #prev-btn { left: 10px; }
  #next-btn { right: 10px; }
</style>

<div class="container py-5">
  {# Messages display (if any) #}
  {% if messages %}
    <div class="mt-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Listing Detail Card with two columns -->
  <div class="card mb-5 shadow listing-detail-card">
    <div class="row g-0">
      <!-- Left Column: Listing Information -->
      <div class="col-md-6 listing-info">
        <h2 class="card-title">{{ listing.title }}</h2>
        <p class="card-text">{{ listing.description }}</p>
        {% if listing.location %}
          <p class="card-text"><strong>Location:</strong> {{ listing.location }}</p>
        {% endif %}
        <p class="card-text text-muted">
          <small>Posted on {{ listing.created_at|date:"M d, Y" }}</small>
        </p>
        <!-- Owner Info -->
        <div class="d-flex align-items-center mt-3">
          {% if listing.librarian.image %}
            <img src="{{ listing.librarian.image.url }}" alt="{{ listing.librarian.username }}" class="rounded-circle me-2" width="50" height="50">
          {% else %}
            <img src="{% static 'images/default_profile.jpg' %}" alt="{{ listing.librarian.username }}" class="rounded-circle me-2" width="50" height="50">
          {% endif %}
          <div>
            <span class="h6 mb-0">{{ listing.librarian.username }}</span>
            {% if listing.librarian.email %}
              <br><small>{{ listing.librarian.email }}</small>
            {% endif %}
          </div>
        </div>
        <!-- Views & Likes -->
        <div class="mt-3">
          <small class="d-block">
            <span id="like-count-{{ listing.pk }}">{{ listing.like_count }}</span> likes&nbsp;
            <a href="{% url 'like_listing' listing.pk %}" class="like-btn-detail" data-listing-id="{{ listing.pk }}" onmousedown="this.blur();" tabindex="-1">
              {% if user in listing.liked_by.all %}
                <img src="{% static 'listing_images/like_icon.png' %}" alt="Liked Icon" width="20" height="20">
              {% else %}
                <img src="{% static 'listing_images/no_like_icon.png' %}" alt="No Like Icon" width="20" height="20">
              {% endif %}
            </a>
            &nbsp;|&nbsp;
            <img src="{% static 'listing_images/view_icon.png' %}" alt="Views Icon" width="20" height="20" class="me-1">
            {{ listing.views }} views
          </small>
        </div>
        <!-- Borrowing/Status Display -->
        <div class="mt-2">
          {% if listing.status == 'checked_in' %}
            <a href="{% url 'borrow_item_page' listing.pk %}" class="btn btn-primary">Borrow</a>
          {% elif listing.status == 'in_circulation' %}
            <span class="badge bg-warning text-dark">In Circulation</span>
          {% elif listing.status == 'being_repaired' %}
            <span class="badge bg-danger">Being Repaired</span>
          {% endif %}
        </div>
        <!-- Action Buttons for Listing Owner -->
        {% if user.is_authenticated and user == listing.librarian %}
          <div class="btn-group mt-3">
            <a href="{% url 'item_edit' listing.pk %}" class="btn btn-secondary">Edit Item</a>
            <a href="{% url 'item_edit_status' listing.pk %}" class="btn btn-secondary">Edit Item Status</a>
          </div>
          <div class="mt-3">
            <form action="{% url 'item_delete' listing.pk %}" method="post" onsubmit="return confirm('Are you sure you want to delete this item? This will remove it from all collections.');">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Delete Item</button>
            </form>
          </div>
        {% endif %}
        <!-- Improved Rating Section on the Listing Detail Card -->
        <div class="rating-container mt-4">
          <h5>Rate this item</h5>
          <div class="d-flex align-items-center">
            <form id="rating-form" method="post" action="{% url 'rate_item' listing.pk %}" class="d-flex align-items-center me-3">
              {% csrf_token %}
              <div class="rating-stars d-flex me-2">
                {% for value in "12345" %}
                  <label class="me-1 star-label" style="cursor:pointer;">
                    <input type="radio" name="rating" value="{{ forloop.counter }}" style="display:none;"
                      {% if user.is_authenticated %}
                        {% with user_rating=listing.ratings|get_user_rating:user %}
                          {% if user_rating and forloop.counter == user_rating %}
                            checked
                          {% endif %}
                        {% endwith %}
                      {% endif %}>
                    <img class="star-img" src="{% static 'listing_images/default-star-empty.png' %}" 
                         alt="{{ forloop.counter }} Star" 
                         width="30" height="30"
                         onmouseover="this.src='{% static 'listing_images/default-star-full.png' %}'" 
                         onmouseout="this.src='{% static 'listing_images/default-star-empty.png' %}'">
                  </label>
                {% endfor %}
              </div>
              <button type="submit" class="btn btn-primary">Submit</button>
            </form>
            <!-- Average Rating Display -->
            <div class="current-rating">
              <span class="me-1">Avg: {{ listing.rating|floatformat:"1" }}</span>
              <div class="rating-display d-inline">
                {% with avg=listing.rating|floatformat:"0"|default:"0" %}
                  {% for i in "12345" %}
                    {% if forloop.counter <= avg|add:"0" %}
                      <img src="{% static 'listing_images/default-star-full.png' %}" alt="Star" width="20" height="20">
                    {% else %}
                      <img src="{% static 'listing_images/default-star-empty.png' %}" alt="Star" width="20" height="20">
                    {% endif %}
                  {% endfor %}
                {% endwith %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Right Column: Image Gallery -->
      <div class="col-md-6 p-0">
        {% if listing.images.all|length > 0 %}
          <!-- Place the title outside of the gallery container -->
          <div id="gallery-container">
            <!-- Main Image Container -->
            <div class="main-image-container" id="main-image-container">
              <img id="gallery-image" src="{{ listing.images.first.image.url }}" alt="Image for {{ listing.title }}" class="img-fluid">
              {% if listing.images.all|length > 1 %}
                <!-- Gallery Buttons -->
                <button id="prev-btn" class="gallery-btn">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
                <button id="next-btn" class="gallery-btn">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Next</span>
                </button>
              {% endif %}
            </div>
            <!-- Thumbnails Column -->
            <div class="thumbnail-container">
              {% for img in listing.images.all %}
                <img class="img-thumbnail thumb-image" src="{{ img.image.url }}" alt="Thumbnail for {{ listing.title }}" onclick="document.getElementById('gallery-image').src='{{ img.image.url }}'; currentIndex={{ forloop.counter0 }};">
              {% endfor %}
            </div>
          </div>
        {% else %}
          <div class="alert alert-info">No images available for this listing.</div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Comments Section (unchanged) -->
  <div class="comment-container p-3 mb-3 shadow-sm">
    <h3>Comments</h3>
    {% if comments %}
      {% for comment in comments %}
      <div class="comment-container p-3 mb-3 bg-white shadow-sm border rounded">
        <div class="d-flex">
          {% if comment.user.image %}
            <img src="{{ comment.user.image.url }}" alt="{{ comment.user.username }}" class="rounded-circle me-3" width="50" height="50">
          {% else %}
            <img src="{% static 'images/default_profile.jpg' %}" alt="{{ comment.user.username }}" class="rounded-circle me-3" width="50" height="50">
          {% endif %}
          <div>
            <!-- Inside your comment loop (in listing_detail.html) -->
            <h6 class="mb-1">
              {{ comment.user.username }}
              {% if comment.user == listing.librarian %}
                <span class="badge bg-info ms-2">Listing Owner</span>
              {% endif %}
              <small class="ms-2">
                {{ comment.created_at|date:"M d, Y h:i A" }}
                {% with user_rating=listing.ratings|get_user_rating:comment.user %}
                  {% if user_rating %}
                    <span class="ms-2 text-warning">
                      {% for i in "12345" %}
                        {% if forloop.counter <= user_rating %}
                          <img src="{% static 'listing_images/default-star-full.png' %}" alt="Star" width="12" height="12">
                        {% else %}
                          <img src="{% static 'listing_images/default-star-empty.png' %}" alt="Star" width="12" height="12">
                        {% endif %}
                      {% endfor %}
                    </span>
                  {% endif %}
                {% endwith %}
              </small>
            </h6>
            <p class="mb-2">{{ comment.comment }}</p>
            <div class="d-flex align-items-center">
              <small>
                <span id="comment-like-count-{{ comment.pk }}">{{ comment.like_count }}</span> likes
              </small>
              <a href="{% url 'like_comment' comment.pk %}" 
                 class="like-btn-comment ms-3" 
                 data-comment-id="{{ comment.pk }}" 
                 onmousedown="this.blur();" 
                 tabindex="-1">
                {% if user in comment.liked_by.all %}
                  <img src="{% static 'listing_images/like_icon.png' %}" alt="Liked Icon" width="16" height="16">
                {% else %}
                  <img src="{% static 'listing_images/no_like_icon.png' %}" alt="No Like Icon" width="16" height="16">
                {% endif %}
              </a>
              {% if user.is_authenticated and comment.user == user %}
                <a href="{% url 'comment_delete' comment.pk %}" class="btn btn-sm btn-outline-danger ms-3">Delete</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info">No comments have been added yet.</div>
    {% endif %}
  </div>
  
  <!-- Comment Form (unchanged) -->
  <div class="container mb-5">
    <div class="card p-4">
      <div class="card-body">
        <h4 class="card-title">Add a Comment</h4>
        {% if user.is_authenticated %}
          <form method="post">
            {% csrf_token %}
            {{ comment_form|crispy }}
            <div class="text-right mt-3">
              <button type="submit" class="btn btn-primary">Submit Comment</button>
            </div>
          </form>
        {% else %}
          <p>Please <a href="{% url 'account_login' %}">login</a> to add a comment.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for Gallery Controls with matching behavior -->
{% if listing.images.all|length > 1 %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  var galleryImages = [
    {% for img in listing.images.all %}
      "{{ img.image.url }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  var currentIndex = 0;
  var intervalId = null;
  var cycleInterval = 3000; // Match the interval from collection_detail
  
  // Function to update displayed image
  function updateImage(index) {
    document.getElementById('gallery-image').src = galleryImages[index];
  }
  
  // Manual controls for previous/next buttons
  document.getElementById('prev-btn').addEventListener('click', function(e){
    e.preventDefault();
    if (intervalId) clearInterval(intervalId);
    currentIndex = (currentIndex - 1 + galleryImages.length) % galleryImages.length;
    updateImage(currentIndex);
  });
  
  document.getElementById('next-btn').addEventListener('click', function(e){
    e.preventDefault();
    if (intervalId) clearInterval(intervalId);
    currentIndex = (currentIndex + 1) % galleryImages.length;
    updateImage(currentIndex);
  });
  
  // Auto-Cycle on Hover (matching collection_detail behavior)
  var mainContainer = document.getElementById("main-image-container");
  
  function cycleImages() {
    currentIndex = (currentIndex + 1) % galleryImages.length;
    updateImage(currentIndex);
  }
  
  mainContainer.addEventListener("mouseenter", function() {
    // Start auto-cycling only on hover
    intervalId = setInterval(cycleImages, cycleInterval);
  });
  
  mainContainer.addEventListener("mouseleave", function() {
    // Stop auto-cycling when mouse leaves
    if (intervalId) {
      clearInterval(intervalId);
      intervalId = null;
    }
  });
  
  // Thumbnail click handler
  document.querySelectorAll('.thumb-image').forEach(function(thumb, index) {
    thumb.addEventListener('click', function() {
      if (intervalId) clearInterval(intervalId);
      currentIndex = index;
      updateImage(currentIndex);
    });
  });
});
</script>
{% endif %}

<!-- AJAX Scripts for Like Buttons, Comments, etc. (unchanged) -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Listing like button handler (existing code)
    const likeBtnDetail = document.querySelector('.like-btn-detail');
    if (likeBtnDetail) {
      likeBtnDetail.addEventListener('click', function(e) {
        e.preventDefault();
        const url = this.href;
        const listingId = this.getAttribute('data-listing-id');
        const btn = this;
        fetch(url, { credentials: 'include' })
          .then(response => {
            if (!response.ok) throw new Error('Network error: ' + response.status);
            return response.json();
          })
          .then(data => {
            const likeCountEl = document.getElementById('like-count-' + listingId);
            likeCountEl.textContent = data.like_count;
            if (data.liked) {
              btn.innerHTML = '<img src="{% static "listing_images/like_icon.png" %}" alt="Liked Icon" width="20" height="20">';
            } else {
              btn.innerHTML = '<img src="{% static "listing_images/no_like_icon.png" %}" alt="No Like Icon" width="20" height="20">';
            }
          })
          .catch(error => console.error('Error:', error));
      });
    }
    // Comment like button handler (existing code)
    document.querySelectorAll('.like-btn-comment').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const url = this.href;
        const commentId = this.getAttribute('data-comment-id');
        const currentBtn = this;
        fetch(url, { 
          credentials: 'include',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
          .then(response => {
            if (!response.ok) throw new Error('Network error: ' + response.status);
            return response.json();
          })
          .then(data => {
            const likeCountEl = document.getElementById('comment-like-count-' + commentId);
            likeCountEl.textContent = data.like_count;
            if (data.liked) {
              currentBtn.innerHTML = '<img src="{% static "listing_images/like_icon.png" %}" alt="Liked Icon" width="16" height="16">';
            } else {
              currentBtn.innerHTML = '<img src="{% static "listing_images/no_like_icon.png" %}" alt="No Like Icon" width="16" height="16">';
            }
          })
          .catch(error => console.error('Error:', error));
      });
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    // Select all star labels within the rating form.
    const starLabels = document.querySelectorAll('#rating-form .star-label');
    
    starLabels.forEach((label, index) => {
      label.addEventListener('click', function(){
        // When a star is clicked, update the source of all star images.
        starLabels.forEach((lbl, i) => {
          const starImg = lbl.querySelector('.star-img');
          if(i <= index) {
            // Set stars at or before clicked index to full.
            starImg.src = "{% static 'listing_images/default-star-full.png' %}";
          } else {
            // And later stars to empty.
            starImg.src = "{% static 'listing_images/default-star-empty.png' %}";
          }
          // Disable further hover effects.
          starImg.onmouseover = null;
          starImg.onmouseout = null;
        });
      });
    });
  });
  document.addEventListener('DOMContentLoaded', function(){
    const ratingContainer = document.querySelector('#rating-form .rating-stars');
    const starLabels = ratingContainer.querySelectorAll('.star-label');
  
    // Update stars up to `hoverIndex` to full; after that, set to empty.
    function updateStars(hoverIndex) {
      starLabels.forEach((label, i) => {
        const starImg = label.querySelector('.star-img');
        starImg.src = (i <= hoverIndex)
          ? "{% static 'listing_images/default-star-full.png' %}"
          : "{% static 'listing_images/default-star-empty.png' %}";
      });
    }
  
    // On hover, if no rating is selected, update stars up to the hovered star.
    starLabels.forEach((label, index) => {
      label.addEventListener('mouseenter', function(){
        const selected = document.querySelector('#rating-form input[name="rating"]:checked');
        if (!selected) {
          updateStars(index);
        }
      });
    });
  
    // When the mouse leaves the rating container, reset all to empty if no rating is selected.
    ratingContainer.addEventListener('mouseleave', function(){
      const selected = document.querySelector('#rating-form input[name="rating"]:checked');
      if (!selected) {
        updateStars(-1);  // No stars lit up.
      }
    });
  });
</script>


{% endblock %}