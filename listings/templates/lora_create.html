{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block hero_content %}
<div class="container my-5">
  <h2 class="mb-4 text-white section-header-animated">Create LoRA</h2>
  <div class="card shadow-sm">
    <div class="card-body">

      <!-- Autofill by link section -->
      <div class="mb-3">
        <label for="lora-link-input" class="form-label">Autofill from Hugging Face Link</label>
        <div class="input-group">
          <input type="url" id="lora-link-input" class="form-control"
                 placeholder="Paste Hugging Face LoRA link here">
          <button type="button" id="autofill-btn" class="btn btn-outline-secondary">
            Autofill
          </button>
        </div>
        <div id="lora-link-input-help" class="form-text text-muted">
          Example: <a href="https://huggingface.co/Nishitbaria/Anime-style-flux-lora-Large">https://huggingface.co/Nishitbaria/Anime-style-flux-lora-Large</a>
        </div>
        <div>
          <small class="form-text">This will fill in the title, description, and up to 5 images from the LoRA page. Autofill works with any link, but best with Hugging Face.</small>
        </div>
        <div id="autofill-status" class="form-text text-muted"></div>
        <!-- image preview container -->
        <div id="autofill-images-preview" class="mt-3 d-flex flex-wrap"></div>
      </div>

      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form|crispy }}

        <!-- Personal Images Upload -->
        <div class="mb-3">
          <label for="id_images" class="form-label">Upload Your Own Images</label>
          <input
            type="file"
            id="id_images"
            name="images"
            class="form-control"
            multiple
            accept="image/*"
          />
          <div class="form-text">You can select multiple images to upload alongside autofill images.</div>
        </div>

        <!-- hidden holder for autofill image URLs -->
        <input
          type="hidden"
          name="autofill_images"
          id="id_autofill_images"
          value=""
        />

        <!-- previews of autofill images -->
        <div id="autofill-images-preview" class="d-flex flex-wrap mb-3"></div>

        <button type="submit" class="btn btn-primary">Create LoRA</button>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn         = document.getElementById("autofill-btn");
  const input       = document.getElementById("lora-link-input");
  const status      = document.getElementById("autofill-status");
  const preview     = document.getElementById("autofill-images-preview");
  const hiddenInput = document.getElementById("id_autofill_images");
  let imagesArr = [];

  function updateHidden() {
    hiddenInput.value = JSON.stringify(imagesArr);
  }

  btn.addEventListener("click", e => {
    e.preventDefault();
    const url = input.value.trim();
    if (!url.startsWith("http")) {
      status.textContent = "Please enter a valid URL.";
      return;
    }
    status.textContent = "Fetching LoRA info…";
    fetch("{% url 'autofill_lora_from_link' %}", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({url})
    })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        status.textContent = "Error: " + data.error;
        return;
      }
      // fill text fields
      document.getElementById("id_title").value       = data.title       || "";
      document.getElementById("id_description").value = data.description || "";
      document.getElementById("id_location").value   = data.location   || "";
      // store / preview images
      imagesArr = Array.isArray(data.image_urls) ? data.image_urls.slice(0,5) : [];
      updateHidden();
      preview.innerHTML = "";

      imagesArr.forEach(src => {
        if (!src) return;
        const wrapper = document.createElement("div");
        wrapper.className = "position-relative m-1";

        const img = document.createElement("img");
        img.src         = src;
        img.style.width = "80px";
        img.className   = "border";

        const delBtn = document.createElement("button");
        delBtn.type      = "button";
        delBtn.innerHTML = "&times;";
        delBtn.className = "btn btn-sm btn-danger position-absolute top-0 end-0";
        delBtn.addEventListener("click", () => {
          // remove from array + hiddenInput, then DOM
          imagesArr = imagesArr.filter(u => u !== src);
          updateHidden();
          wrapper.remove();
        });

        wrapper.appendChild(img);
        wrapper.appendChild(delBtn);
        preview.appendChild(wrapper);
      });

      status.textContent = "Autofill complete – review and click Create LoRA.";
    })
    .catch(err => {
      console.error(err);
      status.textContent = "Fetch failed: " + err.message;
    });
  });
});
</script>
{% endblock %}