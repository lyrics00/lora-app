{% extends "base.html" %}
{% load static %}
{% block hero_content %}
<div class="container my-5">
  <style>
    /* Ensure both single-image containers and carousel items have the same fixed height */
    .image-container,
    .carousel-item {
      height: 250px; 
      overflow: hidden;
    }

    /* Ensure images fill their container */
    .image-container img,
    .carousel-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      border-radius: 8px;
    }
    /* Enhanced search bar styling */
    .lora-searchbar-card {
      background: #23272b;
      border-radius: 1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      padding: 2rem 2rem 1rem 2rem;
      margin-bottom: 2.5rem;
      border: 1px solid #444;
    }
    .lora-searchbar-card label {
      color: #b8eaff;
      font-weight: 500;
    }
    .lora-searchbar-card .form-control,
    .lora-searchbar-card .form-select {
      background: #181a1b;
      color: #fff;
      border: 1px solid #444;
    }
    .lora-searchbar-card .form-control:focus,
    .lora-searchbar-card .form-select:focus {
      border-color: #00bfff;
      box-shadow: 0 0 0 0.2rem rgba(0,191,255,0.15);
    }
    .lora-searchbar-card .btn-outline-primary {
      border-color: #00bfff;
      color: #00bfff;
    }
    .lora-searchbar-card .btn-outline-primary:hover {
      background: #00bfff;
      color: #fff;
    }
    .lora-searchbar-card input::placeholder {
      color: #b8eaff !important; /* or any bright color you prefer */
      opacity: 1; /* ensures the color is not faded */
    }
    @media (max-width: 768px) {
      .lora-searchbar-card {
        padding: 1rem;
      }
    }
    /* push creator info & footer down, let description grow */
    .card-body {
      display: flex;
      flex-direction: column;
    }
    .card-body .card-text {
      flex: 1 1 auto;   /* description takes remaining space */
    }
    .card-body .creator-info {
      margin-top: 1rem; /* space before creator info */
    }
  </style>
  <h2 class="mb-4 text-white section-header-animated">Search LoRAs</h2>
  <div class="lora-searchbar-card">
    <form method="get" class="row g-3 align-items-end">
      <!-- Search text input -->
      <div class="col-12 col-md-4">
        <label for="search-q" class="form-label">Keyword</label>
        <input type="text" id="search-q" name="q" class="form-control" placeholder="Search LoRAs" value="{{ request.GET.q }}">
      </div>
      <!-- Dropdown to select search field: Name or Location -->
      <div class="col-12 col-md-2">
        <label for="search-type" class="form-label">Search By</label>
        <select id="search-type" name="search_type" class="form-select">
          <option value="name" {% if request.GET.search_type == "name" or not request.GET.search_type %}selected{% endif %}>By Name</option>
          <option value="location" {% if request.GET.search_type == "location" %}selected{% endif %}>By Location</option>
        </select>
      </div>
      <!-- Dropdown for Status filtering (using your status_choices) -->
      <div class="col-12 col-md-2">
        <label for="search-status" class="form-label">Status</label>
        <select id="search-status" name="status" class="form-select">
          <option value="">All Statuses</option>
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- Sort By -->
      <div class="col-12 col-md-2">
        <label for="search-sort" class="form-label">Sort By</label>
        <select id="search-sort" name="sort" class="form-select" onchange="this.form.submit()">
          <option value="">-- Select --</option>
          <option value="likes" {% if request.GET.sort == "likes" %}selected{% endif %}>Likes</option>
          <option value="views" {% if request.GET.sort == "views" %}selected{% endif %}>Views</option>
        </select>
      </div>
      <!-- Submit Button -->
      <div class="col-12 col-md-2 d-grid">
        <button type="submit" class="btn btn-outline-primary">Search</button>
      </div>
    </form>
  </div>

  <h2 class="mt-5 mb-3 section-header-animated">Search Results</h2>
  {% if loras %}
    <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
      {% for lora in loras %}
        <div class="col">
          <div class="card h-100 d-flex flex-column">
            {% if lora.images.all %}
              {% if lora.images.all|length > 1 %}
                <div id="carousel-lora-{{ lora.pk }}" class="carousel slide" data-bs-ride="carousel" style="height:250px; overflow:hidden; border-radius:8px;">
                  <div class="carousel-inner" style="height:250px;">
                    {% for image in lora.images.all %}
                      <div class="carousel-item {% if forloop.first %}active{% endif %}" style="height:250px;">
                        <img src="{{ image.image.url }}" class="d-block w-100" alt="{{ lora.title }}" style="height:250px; object-fit:cover; border-radius:8px;">
                      </div>
                    {% endfor %}
                  </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#carousel-lora-{{ lora.pk }}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#carousel-lora-{{ lora.pk }}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                  </button>
                </div>
              {% else %}
                <div class="image-container">
                  <img src="{{ lora.images.first.image.url }}" class="card-img-top" alt="{{ lora.title }}">
                </div>
              {% endif %}
            {% else %}
              <div class="image-container">
                <img src="https://cs3240loraapp.s3.amazonaws.com/items/default_item_image.png" class="card-img-top" alt="No Image">
              </div>
            {% endif %}
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ lora.title }}</h5>
              <p class="card-text">{{ lora.description|truncatewords:20 }}</p>
              <!-- Creator Info placed under description -->
              <div class="creator-info mb-3">
                <div class="d-flex align-items-center">
                  {% if lora.librarian.image %}
                    <img src="{{ lora.librarian.image.url }}" class="rounded-circle me-2" width="40" height="40" alt="{{ lora.librarian.username }}">
                  {% else %}
                    <img src="{% static 'images/default_profile.jpg' %}" class="rounded-circle me-2" width="40" height="40" alt="{{ lora.librarian.username }}">
                  {% endif %}
                  <div>
                    <a href="{% url 'profile' lora.librarian.username %}" class="h6 mb-0 text-decoration-none text-white">
                      {{ lora.librarian.username }}
                    </a>
                    {% if lora.librarian.email %}
                      <small class="d-block">{{ lora.librarian.email }}</small>
                    {% endif %}
                  </div>
                </div>
              </div>
              <!-- Spacer to push footer content to bottom -->
              <div class="mt-auto">
                <!-- Top Row: Views and AJAXâ€‘powered Likes -->
                <div class="d-flex justify-content-between align-items-center">
                  <small>
                    <img src="{% static 'listing_images/view_icon.png' %}" alt="Views" width="20" height="20" class="me-1">
                    {{ lora.views }} views&nbsp;&nbsp;
                    <a href="{% url 'like_listing' lora.pk %}"
                       class="btn btn-link p-0 like-btn-lora"
                       data-lora-id="{{ lora.pk }}"
                       tabindex="-1">
                      {% if user in lora.liked_by.all %}
                        <img src="{% static 'listing_images/like_icon.png' %}" alt="Unlike" width="20" height="20">
                      {% else %}
                        <img src="{% static 'listing_images/no_like_icon.png' %}" alt="Like" width="20" height="20">
                      {% endif %}
                    </a>
                    <span class="like-count">{{ lora.liked_by.count }}</span> likes
                  </small>
                </div>
                <!-- Second Row: Average Rating -->
                <div class="d-flex align-items-center mt-2">
                  <span class="me-2">Avg: {{ lora.rating|floatformat:"1" }}</span>
                  <div class="rating-display d-inline">
                    {% with avg=lora.rating|floatformat:"0"|default:"0" %}
                      {% for i in "12345" %}
                        {% if forloop.counter <= avg|add:"0" %}
                          <img src="{% static 'listing_images/default-star-full.png' %}" alt="Star" width="16" height="16">
                        {% else %}
                          <img src="{% static 'listing_images/default-star-empty.png' %}" alt="Star" width="16" height="16">
                        {% endif %}
                      {% endfor %}
                    {% endwith %}
                  </div>
                </div>
                <!-- Third Row: Details Button moved below the review -->
                <div class="d-flex justify-content-center mt-3">
                  <a href="{% url 'listing_detail' lora.pk %}" class="btn btn-primary w-100">View Details</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning mt-2 mb-2">No LoRAs found.</div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.like-btn-lora').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.href;
      const likeBtn = this;
      fetch(url, { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          // update like count
          const countEl = likeBtn.parentElement.querySelector('.like-count');
          countEl.textContent = data.like_count;
          // toggle icon
          const img = likeBtn.querySelector('img');
          img.src = data.liked
            ? "{% static 'listing_images/like_icon.png' %}"
            : "{% static 'listing_images/no_like_icon.png' %}";
        })
        .catch(console.error);
    });
  });
});
</script>

{% endblock %}
