{% extends "base.html" %}
{% load static %}
{% load duration_filters %}
{% block hero_content %}
<div class="container my-5">
  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
  
  <h2 class="mb-4">Borrowed LoRAs</h2>
  {% if borrowed_loras %}
    <div class="row row-cols-1 row-cols-md-2 g-4">
      {% for borrowed in borrowed_loras %}
        <div class="col">
          <div class="card h-100 shadow-sm">  
            <div class="card-body">
              <h5 class="card-title">{{ borrowed.lora.title }}</h5>
              <p class="card-text">
                <strong>Borrowed on:</strong> {{ borrowed.start_date|date:"M d, Y H:i" }}<br>
                <strong>Due on:</strong> {{ borrowed.due_date|date:"M d, Y H:i" }}<br>
                <strong>Duration:</strong> {{ borrowed.duration|simplify_duration }}<br>
                <strong>Time left:</strong> <span class="countdown badge bg-warning" data-due="{{ borrowed.due_date|date:'U' }}"></span>
              </p>
              <div class="mt-3">
                <a href="{% url 'return_borrowed_lora' borrowed.pk %}" class="btn btn-sm btn-outline-primary">
                  Return LoRA
                </a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info" role="alert">
      No borrowed LoRAs found.
    </div>
  {% endif %}
</div>

<!-- Countdown Script -->
<script>
  function updateCountdown() {
    var countdownElements = document.querySelectorAll('.countdown');
    countdownElements.forEach(function(el) {
      var dueTimestamp = parseInt(el.getAttribute('data-due')) * 1000; // convert seconds to ms
      var now = new Date().getTime();
      var diff = dueTimestamp - now;
      if(diff <= 0) {
         el.innerHTML = "Expired";
         el.classList.remove("bg-warning");
         el.classList.add("bg-danger");
      } else {
         var days = Math.floor(diff / (1000 * 60 * 60 * 24));
         var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
         var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
         var seconds = Math.floor((diff % (1000 * 60)) / 1000);
         el.innerHTML = days + "d " + hours + "h " + minutes + "m " + seconds + "s";
      }
    });
  }
  updateCountdown();
  setInterval(updateCountdown, 1000);
</script>
{% endblock %}